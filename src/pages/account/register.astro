---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Create Account â€“ Vapelink Australia" description="Create your Vapelink Australia account to track orders, save your details and checkout faster." noindex={true}>
  <nav class="breadcrumb-bar">
    <div class="container">
      <ol class="breadcrumb">
        <li><a href="/">Home</a></li>
        <li><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg></li>
        <li><span class="breadcrumb-current">Create Account</span></li>
      </ol>
    </div>
  </nav>

  <section class="container auth-page">
    <div class="auth-card">
      <div class="auth-header">
        <div class="auth-icon-wrap">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--color-accent)" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="22" y1="11" x2="16" y2="11"/></svg>
        </div>
        <h1 class="font-display auth-title">Create Account</h1>
        <p class="auth-subtitle">Join Vapelink Australia to save your details, track orders and checkout faster.</p>
      </div>

      <!-- Google Sign-Up -->
      <button id="google-signup-btn" class="google-btn" type="button">
        <svg width="18" height="18" viewBox="0 0 24 24">
          <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#4285F4"/>
          <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
          <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
          <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
        </svg>
        Continue with Google
      </button>

      <div class="auth-divider">
        <span>or register with email</span>
      </div>

      <!-- Register Form -->
      <form id="register-form" class="auth-form">
        <div class="auth-row-2">
          <label class="auth-field">
            <span class="auth-label">First Name <span class="req">*</span></span>
            <input type="text" id="reg-fname" placeholder="John" class="auth-input" required />
          </label>
          <label class="auth-field">
            <span class="auth-label">Last Name <span class="req">*</span></span>
            <input type="text" id="reg-lname" placeholder="Doe" class="auth-input" required />
          </label>
        </div>
        <label class="auth-field">
          <span class="auth-label">Email Address <span class="req">*</span></span>
          <input type="email" id="reg-email" placeholder="your@email.com" class="auth-input" required />
        </label>
        <label class="auth-field">
          <span class="auth-label">Phone Number</span>
          <input type="tel" id="reg-phone" placeholder="+61 400 000 000" class="auth-input" />
        </label>
        <label class="auth-field">
          <span class="auth-label">Password <span class="req">*</span></span>
          <div class="auth-password-wrap">
            <input type="password" id="reg-password" placeholder="Min 6 characters" class="auth-input" required minlength="6" />
            <button type="button" class="auth-password-toggle" data-target="reg-password" aria-label="Show password">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
            </button>
          </div>
        </label>
        <label class="auth-field">
          <span class="auth-label">Confirm Password <span class="req">*</span></span>
          <div class="auth-password-wrap">
            <input type="password" id="reg-confirm" placeholder="Re-enter password" class="auth-input" required />
            <button type="button" class="auth-password-toggle" data-target="reg-confirm" aria-label="Show password">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
            </button>
          </div>
        </label>

        <!-- Password strength indicator -->
        <div id="password-strength" class="password-strength" style="display:none;">
          <div class="strength-bar"><div id="strength-fill" class="strength-fill"></div></div>
          <span id="strength-text" class="strength-text"></span>
        </div>

        <label class="auth-agree">
          <input type="checkbox" id="reg-agree" class="agree-checkbox" required />
          <span class="agree-text">I confirm I am 18+ years of age and agree to the <a href="/pages/terms-conditions">Terms & Conditions</a> and <a href="/pages/privacy-policy">Privacy Policy</a>.</span>
        </label>

        <div id="register-error" class="auth-error" style="display:none;"></div>
        <div id="register-success" class="auth-success" style="display:none;"></div>

        <button type="submit" class="btn-primary auth-submit-btn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="22" y1="11" x2="16" y2="11"/></svg>
          Create Account
        </button>
      </form>

      <div class="auth-footer">
        <p>Already have an account? <a href="/account/login" class="auth-link">Sign in</a></p>
      </div>
    </div>
  </section>

  <script>
    // Check if already logged in
    try {
      const user = JSON.parse(localStorage.getItem('vapelink_user') || 'null');
      if (user) window.location.href = '/account';
    } catch {}

    // Password toggle
    document.querySelectorAll('.auth-password-toggle').forEach(btn => {
      btn.addEventListener('click', () => {
        const target = (btn as HTMLElement).dataset.target;
        if (!target) return;
        const input = document.getElementById(target) as HTMLInputElement;
        if (!input) return;
        const isPassword = input.type === 'password';
        input.type = isPassword ? 'text' : 'password';
        (btn as HTMLElement).innerHTML = isPassword
          ? '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>'
          : '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>';
      });
    });

    // Password strength
    const passwordInput = document.getElementById('reg-password') as HTMLInputElement;
    const strengthWrap = document.getElementById('password-strength');
    const strengthFill = document.getElementById('strength-fill');
    const strengthText = document.getElementById('strength-text');

    passwordInput?.addEventListener('input', () => {
      const val = passwordInput.value;
      if (!strengthWrap || !strengthFill || !strengthText) return;
      if (!val) { strengthWrap.style.display = 'none'; return; }
      strengthWrap.style.display = 'flex';

      let score = 0;
      if (val.length >= 6) score++;
      if (val.length >= 10) score++;
      if (/[A-Z]/.test(val)) score++;
      if (/[0-9]/.test(val)) score++;
      if (/[^A-Za-z0-9]/.test(val)) score++;

      const levels = [
        { label: 'Very Weak', color: '#DC2626', width: '20%' },
        { label: 'Weak', color: '#F59E0B', width: '40%' },
        { label: 'Fair', color: '#F59E0B', width: '60%' },
        { label: 'Strong', color: '#16A34A', width: '80%' },
        { label: 'Very Strong', color: '#16A34A', width: '100%' },
      ];
      const level = levels[Math.min(score, levels.length) - 1] || levels[0];
      strengthFill.style.width = level.width;
      strengthFill.style.background = level.color;
      strengthText.textContent = level.label;
      strengthText.style.color = level.color;
    });

    // Register form
    document.getElementById('register-form')?.addEventListener('submit', (e) => {
      e.preventDefault();
      const fname = (document.getElementById('reg-fname') as HTMLInputElement)?.value.trim();
      const lname = (document.getElementById('reg-lname') as HTMLInputElement)?.value.trim();
      const email = (document.getElementById('reg-email') as HTMLInputElement)?.value.trim().toLowerCase();
      const phone = (document.getElementById('reg-phone') as HTMLInputElement)?.value.trim();
      const password = (document.getElementById('reg-password') as HTMLInputElement)?.value;
      const confirm = (document.getElementById('reg-confirm') as HTMLInputElement)?.value;
      const agree = (document.getElementById('reg-agree') as HTMLInputElement)?.checked;
      const errorEl = document.getElementById('register-error');
      const successEl = document.getElementById('register-success');

      if (!fname || !lname || !email || !password) return;

      // Validations
      if (!agree) {
        if (errorEl) { errorEl.textContent = 'You must agree to the Terms & Conditions to create an account.'; errorEl.style.display = 'block'; }
        return;
      }
      if (password !== confirm) {
        if (errorEl) { errorEl.textContent = 'Passwords do not match.'; errorEl.style.display = 'block'; }
        return;
      }
      if (password.length < 6) {
        if (errorEl) { errorEl.textContent = 'Password must be at least 6 characters.'; errorEl.style.display = 'block'; }
        return;
      }
      if (!email.includes('@') || !email.includes('.')) {
        if (errorEl) { errorEl.textContent = 'Please enter a valid email address.'; errorEl.style.display = 'block'; }
        return;
      }

      try {
        const accounts: any[] = JSON.parse(localStorage.getItem('vapelink_accounts') || '[]');
        if (accounts.find((a: any) => a.email === email)) {
          if (errorEl) { errorEl.textContent = 'An account with this email already exists. Please sign in instead.'; errorEl.style.display = 'block'; }
          return;
        }

        const newAccount = { firstName: fname, lastName: lname, email, phone, password, created: new Date().toISOString() };
        accounts.push(newAccount);
        localStorage.setItem('vapelink_accounts', JSON.stringify(accounts));
        localStorage.setItem('vapelink_user', JSON.stringify({ firstName: fname, lastName: lname, email, phone }));

        if (errorEl) errorEl.style.display = 'none';
        if (successEl) { successEl.textContent = 'Account created successfully! Redirecting...'; successEl.style.display = 'block'; }

        setTimeout(() => {
          const redirect = new URLSearchParams(window.location.search).get('redirect') || '/account';
          window.location.href = redirect;
        }, 1000);
      } catch {
        if (errorEl) { errorEl.textContent = 'Something went wrong. Please try again.'; errorEl.style.display = 'block'; }
      }
    });

    // Google Sign-Up
    document.getElementById('google-signup-btn')?.addEventListener('click', () => {
      const g = (window as any).google;
      if (typeof g !== 'undefined' && g.accounts) {
        g.accounts.id.initialize({
          client_id: '',
          callback: handleGoogleResponse,
          auto_select: false
        });
        g.accounts.id.prompt();
      } else {
        alert('Google Sign-In is being configured. Please use email registration for now, or contact support.');
      }
    });

    function handleGoogleResponse(response: any) {
      try {
        const payload = JSON.parse(atob(response.credential.split('.')[1]));
        const email = payload.email?.toLowerCase();
        const firstName = payload.given_name || '';
        const lastName = payload.family_name || '';

        let accounts: any[] = JSON.parse(localStorage.getItem('vapelink_accounts') || '[]');
        let account = accounts.find((a: any) => a.email === email);
        if (!account) {
          account = { firstName, lastName, email, password: '__google_oauth__', provider: 'google', created: new Date().toISOString() };
          accounts.push(account);
          localStorage.setItem('vapelink_accounts', JSON.stringify(accounts));
        }

        localStorage.setItem('vapelink_user', JSON.stringify({ firstName: account.firstName || firstName, lastName: account.lastName || lastName, email }));
        const redirect = new URLSearchParams(window.location.search).get('redirect') || '/account';
        window.location.href = redirect;
      } catch (err) {
        console.error('Google sign-up error:', err);
      }
    }
  </script>
</Layout>

<style is:global>
  .auth-page {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 60vh;
    padding: 3rem 1rem;
  }
  .auth-card {
    width: 100%;
    max-width: 480px;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-xl);
    padding: 2.5rem;
    box-shadow: var(--shadow-xs);
  }
  .auth-header {
    text-align: center;
    margin-bottom: 2rem;
  }
  .auth-icon-wrap {
    width: 56px;
    height: 56px;
    margin: 0 auto 1rem;
    border-radius: 50%;
    background: var(--color-accent-soft);
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .auth-title {
    font-size: 1.5rem;
    font-weight: 800;
    color: var(--color-text);
    margin-bottom: 0.35rem;
    letter-spacing: -0.02em;
  }
  .auth-subtitle {
    font-size: 0.88rem;
    color: var(--color-text-secondary);
    line-height: 1.6;
  }
  .google-btn {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.65rem;
    padding: 0.8rem 1rem;
    background: var(--color-surface);
    border: 1.5px solid var(--color-border);
    border-radius: var(--radius-md);
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--color-text);
    cursor: pointer;
    transition: all 0.15s ease;
    font-family: 'Inter', sans-serif;
  }
  .google-btn:hover {
    border-color: var(--color-border-hover);
    background: var(--color-surface-alt);
    box-shadow: var(--shadow-xs);
  }
  .auth-divider {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin: 1.5rem 0;
  }
  .auth-divider::before,
  .auth-divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--color-border);
  }
  .auth-divider span {
    font-size: 0.75rem;
    color: var(--color-text-muted);
    white-space: nowrap;
    font-family: 'Space Grotesk', sans-serif;
  }
  .auth-form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  .auth-row-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.85rem;
  }
  @media (max-width: 480px) {
    .auth-row-2 { grid-template-columns: 1fr; }
  }
  .auth-field {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }
  .auth-label {
    font-size: 0.78rem;
    font-weight: 600;
    color: var(--color-text-secondary);
    font-family: 'Space Grotesk', sans-serif;
  }
  .req { color: var(--color-sale); }
  .auth-input {
    padding: 0.75rem 0.85rem;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    font-size: 0.88rem;
    color: var(--color-text);
    background: var(--color-surface-alt);
    outline: none;
    font-family: 'Inter', sans-serif;
    transition: border-color 0.15s ease, box-shadow 0.15s ease;
    width: 100%;
  }
  .auth-input:focus {
    border-color: var(--color-accent);
    box-shadow: 0 0 0 3px var(--color-accent-soft);
  }
  .auth-input::placeholder { color: var(--color-text-muted); }
  .auth-password-wrap {
    position: relative;
  }
  .auth-password-wrap .auth-input {
    padding-right: 2.75rem;
  }
  .auth-password-toggle {
    position: absolute;
    right: 0.65rem;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: var(--color-text-muted);
    cursor: pointer;
    padding: 0.2rem;
    transition: color 0.15s ease;
    display: flex;
    align-items: center;
  }
  .auth-password-toggle:hover { color: var(--color-text-secondary); }
  .password-strength {
    display: flex;
    align-items: center;
    gap: 0.65rem;
  }
  .strength-bar {
    flex: 1;
    height: 4px;
    background: var(--color-surface-alt);
    border-radius: 2px;
    overflow: hidden;
  }
  .strength-fill {
    height: 100%;
    border-radius: 2px;
    transition: width 0.3s ease, background 0.3s ease;
    width: 0%;
  }
  .strength-text {
    font-size: 0.72rem;
    font-weight: 600;
    font-family: 'Space Grotesk', sans-serif;
    white-space: nowrap;
  }
  .auth-agree {
    display: flex;
    align-items: flex-start;
    gap: 0.65rem;
    cursor: pointer;
  }
  .agree-checkbox {
    width: 18px;
    height: 18px;
    margin-top: 0.1rem;
    accent-color: var(--color-accent);
    flex-shrink: 0;
  }
  .agree-text {
    font-size: 0.82rem;
    color: var(--color-text-secondary);
    line-height: 1.5;
  }
  .agree-text a {
    color: var(--color-accent);
    text-decoration: none;
    font-weight: 600;
  }
  .agree-text a:hover { text-decoration: underline; }
  .auth-error {
    background: var(--color-sale-soft);
    border: 1px solid rgba(220, 38, 38, 0.2);
    border-radius: var(--radius-sm);
    padding: 0.65rem 0.85rem;
    font-size: 0.82rem;
    color: var(--color-sale);
    font-weight: 500;
  }
  .auth-success {
    background: var(--color-success-soft);
    border: 1px solid rgba(22, 163, 74, 0.2);
    border-radius: var(--radius-sm);
    padding: 0.65rem 0.85rem;
    font-size: 0.82rem;
    color: var(--color-success);
    font-weight: 500;
  }
  .auth-submit-btn {
    width: 100%;
    padding: 0.8rem;
    justify-content: center;
    font-size: 0.92rem;
    margin-top: 0.5rem;
  }
  .auth-footer {
    text-align: center;
    margin-top: 1.5rem;
    padding-top: 1.25rem;
    border-top: 1px solid var(--color-border);
  }
  .auth-footer p {
    font-size: 0.85rem;
    color: var(--color-text-secondary);
  }
  .auth-link {
    color: var(--color-accent);
    font-weight: 600;
    text-decoration: none;
  }
  .auth-link:hover { text-decoration: underline; }
</style>
