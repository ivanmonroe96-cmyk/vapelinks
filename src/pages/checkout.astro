---
import Layout from '../layouts/Layout.astro';
import siteData from '../data/site.json';
---

<Layout title="Checkout – Vapelink Australia" description="Complete your order at Vapelink Australia." noindex={true}>

  <!-- Breadcrumb -->
  <nav class="breadcrumb-bar">
    <div class="container">
      <ol class="breadcrumb">
        <li><a href="/">Home</a></li>
        <li><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg></li>
        <li><a href="/cart">Cart</a></li>
        <li><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg></li>
        <li><span class="breadcrumb-current">Checkout</span></li>
      </ol>
    </div>
  </nav>

  <section class="container checkout-page">
    <!-- Empty redirect -->
    <div id="checkout-empty" style="display:none;">
      <div class="checkout-empty-inner">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--color-text-dim)" stroke-width="1.2"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
        <h2 class="font-display" style="font-size:1.2rem;font-weight:700;color:var(--color-text);margin-top:1rem;">Your cart is empty</h2>
        <p style="color:var(--color-text-secondary);font-size:0.88rem;margin-top:0.35rem;">Add some items before checking out.</p>
        <a href="/collections/shop" class="btn-primary" style="margin-top:1.25rem;padding:0.7rem 2rem;">Browse Products</a>
      </div>
    </div>

    <!-- Checkout form -->
    <div id="checkout-content" style="display:none;">
      <!-- Progress Steps -->
      <div class="checkout-steps">
        <div class="checkout-step active" data-step="1">
          <span class="step-num">1</span>
          <span class="step-label">Details</span>
        </div>
        <div class="step-connector"></div>
        <div class="checkout-step" data-step="2">
          <span class="step-num">2</span>
          <span class="step-label">Shipping</span>
        </div>
        <div class="step-connector"></div>
        <div class="checkout-step" data-step="3">
          <span class="step-num">3</span>
          <span class="step-label">Payment</span>
        </div>
      </div>

      <div class="checkout-grid">
        <!-- Form Column -->
        <div class="checkout-form-col">
          <!-- Step 1: Contact & Details -->
          <div id="step-1" class="checkout-step-content">
            <div class="checkout-section">
              <h2 class="font-display checkout-section-title">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--color-accent)" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                Contact Information (Guest Checkout)
              </h2>
              <div class="form-row">
                <label class="form-field">
                  <span class="form-label">Email Address <span class="req">*</span></span>
                  <input type="email" id="checkout-email" class="form-input" placeholder="your@email.com" required />
                </label>
              </div>
              <div class="form-row">
                <label class="form-field">
                  <span class="form-label">Phone Number</span>
                  <input type="tel" id="checkout-phone" class="form-input" placeholder="+61 400 000 000" />
                </label>
              </div>
            </div>

            <div class="checkout-section">
              <h2 class="font-display checkout-section-title">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--color-accent)" stroke-width="2"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
                Shipping Address
              </h2>
              <div class="form-row form-row-2">
                <label class="form-field">
                  <span class="form-label">First Name <span class="req">*</span></span>
                  <input type="text" id="checkout-fname" class="form-input" placeholder="John" required />
                </label>
                <label class="form-field">
                  <span class="form-label">Last Name <span class="req">*</span></span>
                  <input type="text" id="checkout-lname" class="form-input" placeholder="Doe" required />
                </label>
              </div>
              <div class="form-row">
                <label class="form-field">
                  <span class="form-label">Street Address <span class="req">*</span></span>
                  <input type="text" id="checkout-address" class="form-input" placeholder="123 Main Street" required />
                </label>
              </div>
              <div class="form-row">
                <label class="form-field">
                  <span class="form-label">Apartment, suite, etc. (optional)</span>
                  <input type="text" id="checkout-address2" class="form-input" placeholder="Apt 4B" />
                </label>
              </div>
              <div class="form-row form-row-3">
                <label class="form-field">
                  <span class="form-label">City <span class="req">*</span></span>
                  <input type="text" id="checkout-city" class="form-input" placeholder="Melbourne" required />
                </label>
                <label class="form-field">
                  <span class="form-label">State <span class="req">*</span></span>
                  <select id="checkout-state" class="form-input form-select" required>
                    <option value="">Select</option>
                    <option value="VIC">VIC</option>
                    <option value="NSW">NSW</option>
                    <option value="QLD">QLD</option>
                    <option value="WA">WA</option>
                    <option value="SA">SA</option>
                    <option value="TAS">TAS</option>
                    <option value="ACT">ACT</option>
                    <option value="NT">NT</option>
                  </select>
                </label>
                <label class="form-field">
                  <span class="form-label">Postcode <span class="req">*</span></span>
                  <input type="text" id="checkout-postcode" class="form-input" placeholder="3000" maxlength="4" required />
                </label>
              </div>
              <div class="form-row">
                <label class="form-field">
                  <span class="form-label">Country</span>
                  <input type="text" class="form-input" value="Australia" disabled style="background:var(--color-surface-alt);color:var(--color-text-muted);" />
                </label>
              </div>
            </div>

            <div class="form-actions">
              <a href="/cart" class="btn-secondary" style="padding:0.75rem 1.5rem;text-decoration:none;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
                Back to Cart
              </a>
              <button type="button" id="to-step-2" class="btn-primary" style="padding:0.75rem 2rem;">
                Continue to Shipping
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
              </button>
            </div>
          </div>

          <!-- Step 2: Shipping Method -->
          <div id="step-2" class="checkout-step-content" style="display:none;">
            <div class="checkout-section">
              <h2 class="font-display checkout-section-title">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--color-accent)" stroke-width="2"><rect x="1" y="3" width="15" height="13"/><path d="m16 8 4 2v6H16"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>
                Shipping Method
              </h2>
              <div class="shipping-options">
                <label class="shipping-option">
                  <input type="radio" name="shipping" value="standard" checked class="shipping-radio" />
                  <div class="shipping-option-content">
                    <div>
                      <span class="shipping-name">Standard Shipping</span>
                      <span class="shipping-time">5–10 business days</span>
                    </div>
                    <span class="shipping-price font-display">$9.95</span>
                  </div>
                </label>
                <label class="shipping-option">
                  <input type="radio" name="shipping" value="express" class="shipping-radio" />
                  <div class="shipping-option-content">
                    <div>
                      <span class="shipping-name">Express Shipping</span>
                      <span class="shipping-time">2–4 business days</span>
                    </div>
                    <span class="shipping-price font-display">$14.95</span>
                  </div>
                </label>

              </div>
            </div>

            <div class="checkout-section">
              <h2 class="font-display checkout-section-title">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--color-accent)" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>
                Order Notes (optional)
              </h2>
              <textarea id="checkout-notes" class="form-input form-textarea" placeholder="Any special instructions for your order..." rows="3"></textarea>
            </div>

            <div class="form-actions">
              <button type="button" id="back-step-1" class="btn-secondary" style="padding:0.75rem 1.5rem;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
                Back
              </button>
              <button type="button" id="to-step-3" class="btn-primary" style="padding:0.75rem 2rem;">
                Continue to Payment
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
              </button>
            </div>
          </div>

          <!-- Step 3: Payment -->
          <div id="step-3" class="checkout-step-content" style="display:none;">
            <div class="checkout-section">
              <h2 class="font-display checkout-section-title">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--color-accent)" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><path d="M1 10h22"/></svg>
                Payment Method
              </h2>

              <div class="payment-info-box">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--color-accent)" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                <div>
                  <p style="font-weight:600;color:var(--color-text);font-size:0.88rem;">Secure Payment</p>
                  <p style="color:var(--color-text-secondary);font-size:0.82rem;margin-top:0.15rem;">Your order details will be sent to our team for processing. We accept bank transfer, PayID, and Bitcoin.</p>
                </div>
              </div>

              <div class="payment-methods">
                <label class="payment-method-option">
                  <input type="radio" name="payment" value="bank" checked class="shipping-radio" />
                  <div class="shipping-option-content">
                    <div>
                      <span class="shipping-name">Bank Transfer / PayID</span>
                      <span class="shipping-time">Details provided after order</span>
                    </div>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--color-text-secondary)" stroke-width="1.5"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M2 10h20"/><path d="M6 16h4"/></svg>
                  </div>
                </label>
                <label class="payment-method-option">
                  <input type="radio" name="payment" value="bitcoin" class="shipping-radio" />
                  <div class="shipping-option-content">
                    <div>
                      <span class="shipping-name">Bitcoin (BTC)</span>
                      <span class="shipping-time">Pay via QR code — instant confirmation</span>
                    </div>
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--color-text-secondary)" stroke-width="1.5"><path d="M11.767 19.089c4.924.868 6.14-6.025 1.216-6.894m-1.216 6.894L5.86 18.047m5.908 1.042-.347 1.97m1.563-8.864c4.924.869 6.14-6.025 1.215-6.893m-1.215 6.893-3.94-.694m5.155-6.2L8.29 4.26m5.908 1.042.348-1.97M7.48 20.364l3.126-17.727"/></svg>
                  </div>
                </label>

              </div>
            </div>

            <div class="checkout-section">
              <label class="checkout-agree">
                <input type="checkbox" id="checkout-agree" class="agree-checkbox" />
                <span class="agree-text">I confirm I am 18+ years of age and agree to the <a href="/pages/terms-conditions">Terms & Conditions</a> and <a href="/pages/privacy-policy">Privacy Policy</a>.</span>
              </label>
            </div>

            <div class="form-actions">
              <button type="button" id="back-step-2" class="btn-secondary" style="padding:0.75rem 1.5rem;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
                Back
              </button>
              <button type="button" id="place-order" class="btn-primary" style="padding:0.85rem 2.5rem;font-size:0.95rem;" disabled>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                Place Order
              </button>
            </div>
          </div>
        </div>

        <!-- Order Summary Sidebar -->
        <aside class="checkout-summary">
          <h3 class="font-display checkout-summary-title">Order Summary</h3>
          <div id="checkout-items" class="checkout-items"></div>
          <hr class="checkout-divider" />
          <div class="checkout-summary-row">
            <span>Subtotal</span>
            <span id="checkout-subtotal" class="font-display" style="font-weight:600;">$0.00</span>
          </div>
          <div class="checkout-summary-row">
            <span>Shipping</span>
            <span id="checkout-shipping" class="font-display" style="font-weight:600;">$9.95</span>
          </div>
          <hr class="checkout-divider" />
          <div class="checkout-summary-row checkout-total-row">
            <span>Total</span>
            <span id="checkout-total" class="font-display">$0.00 AUD</span>
          </div>
          <p class="checkout-tax-note">Inclusive of all applicable taxes</p>
        </aside>
      </div>
    </div>
  </section>

  <style is:global>
    .checkout-page {
      padding-top: var(--space-xl);
      padding-bottom: var(--space-3xl);
      min-height: 60vh;
    }

    /* ── Empty State ── */
    .checkout-empty-inner {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      padding: 4rem 1rem;
    }

    /* ── Progress Steps ── */
    .checkout-steps {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0;
      margin-bottom: 2.5rem;
      padding: 1.5rem 2rem;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-sm);
    }
    .checkout-step {
      display: flex;
      align-items: center;
      gap: 0.55rem;
      opacity: 0.38;
      transition: opacity 0.25s ease;
    }
    .checkout-step.active { opacity: 1; }
    .checkout-step.completed { opacity: 0.75; }
    .step-num {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--color-surface-alt);
      border: 1.5px solid var(--color-border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.78rem;
      font-weight: 700;
      font-family: var(--font-display);
      color: var(--color-text-secondary);
      transition: all 0.25s ease;
    }
    .checkout-step.active .step-num {
      background: var(--color-accent);
      border-color: var(--color-accent);
      color: #fff;
      box-shadow: 0 0 0 4px rgba(22,163,74,0.15);
    }
    .checkout-step.completed .step-num {
      background: var(--color-accent-soft);
      border-color: var(--color-accent);
      color: var(--color-accent);
    }
    .step-label {
      font-size: 0.84rem;
      font-weight: 700;
      color: var(--color-text-secondary);
      font-family: var(--font-display);
      letter-spacing: -0.01em;
    }
    .checkout-step.active .step-label { color: var(--color-text); }
    .step-connector {
      flex: 1;
      height: 1.5px;
      background: var(--color-border);
      margin: 0 1rem;
      min-width: 32px;
    }

    /* ── Grid ── */
    .checkout-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 2rem;
    }
    @media (min-width: 1024px) {
      .checkout-grid {
        grid-template-columns: 1fr 380px;
        gap: 2.5rem;
        align-items: start;
      }
    }

    /* ── Sections ── */
    .checkout-section {
      margin-bottom: 1.5rem;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-xl);
      padding: 1.75rem;
      box-shadow: var(--shadow-sm);
    }
    .checkout-section-title {
      display: flex;
      align-items: center;
      gap: 0.65rem;
      font-size: 1rem;
      font-weight: 700;
      color: var(--color-text);
      margin-bottom: 1.25rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--color-border);
    }

    /* ── Forms ── */
    .form-row {
      margin-bottom: 0.85rem;
    }
    .form-row-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.85rem;
    }
    .form-row-3 {
      display: grid;
      grid-template-columns: 1fr 100px 100px;
      gap: 0.85rem;
    }
    @media (max-width: 640px) {
      .form-row-2, .form-row-3 { grid-template-columns: 1fr; }
    }
    .form-field {
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
    }
    .form-label {
      font-size: 0.78rem;
      font-weight: 600;
      color: var(--color-text-secondary);
      font-family: var(--font-display);
    }
    .req { color: var(--color-sale); }
    .form-input {
      padding: 0.75rem 1rem;
      border: 1.5px solid var(--color-border);
      border-radius: var(--radius-md);
      font-size: 0.88rem;
      color: var(--color-text);
      background: var(--color-bg);
      outline: none;
      font-family: var(--font-body);
      transition: border-color 0.18s ease, box-shadow 0.18s ease;
      width: 100%;
    }
    .form-input:focus {
      border-color: var(--color-accent);
      box-shadow: 0 0 0 3px rgba(22,163,74,0.12);
      background: var(--color-surface);
    }
    .form-input::placeholder { color: var(--color-text-muted); }
    .form-select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23999' stroke-width='2' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      padding-right: 2rem;
    }
    .form-textarea {
      resize: vertical;
      min-height: 80px;
    }

    .form-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--color-border);
      gap: 1rem;
    }
    @media (max-width: 480px) {
      .form-actions {
        flex-direction: column;
      }
      .form-actions .btn-primary,
      .form-actions .btn-secondary { width: 100%; justify-content: center; }
    }

    /* ── Shipping Options ── */
    .shipping-options, .payment-methods {
      display: flex;
      flex-direction: column;
      gap: 0.65rem;
    }
    .shipping-option, .payment-method-option {
      cursor: pointer;
    }
    .shipping-radio {
      display: none;
    }
    .shipping-option-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.25rem;
      border: 1.5px solid var(--color-border);
      border-radius: var(--radius-lg);
      background: var(--color-bg);
      transition: all 0.18s ease;
    }
    .shipping-option-content:hover {
      border-color: rgba(22,163,74,0.4);
      box-shadow: 0 2px 8px rgba(22,163,74,0.07);
    }
    .shipping-radio:checked + .shipping-option-content {
      border-color: var(--color-accent);
      background: linear-gradient(135deg, #F0FDF4 0%, #DCFCE7 100%);
      box-shadow: 0 2px 12px rgba(22,163,74,0.12);
    }
    .shipping-name {
      display: block;
      font-size: 0.88rem;
      font-weight: 600;
      color: var(--color-text);
    }
    .shipping-time {
      display: block;
      font-size: 0.75rem;
      color: var(--color-text-muted);
      margin-top: 0.15rem;
    }
    .shipping-price {
      font-size: 0.92rem;
      font-weight: 700;
      color: var(--color-text);
    }

    /* ── Payment Info ── */
    .payment-info-box {
      display: flex;
      gap: 0.85rem;
      padding: 1rem 1.15rem;
      background: var(--color-accent-soft);
      border: 1px solid var(--color-accent);
      border-radius: var(--radius-md);
      margin-bottom: 1.25rem;
      align-items: flex-start;
    }
    .payment-info-box svg {
      flex-shrink: 0;
      margin-top: 0.1rem;
    }

    /* ── Agree Checkbox ── */
    .checkout-agree {
      display: flex;
      align-items: flex-start;
      gap: 0.65rem;
      cursor: pointer;
    }
    .agree-checkbox {
      width: 18px;
      height: 18px;
      margin-top: 0.1rem;
      accent-color: var(--color-accent);
      flex-shrink: 0;
    }
    .agree-text {
      font-size: 0.82rem;
      color: var(--color-text-secondary);
      line-height: 1.5;
    }
    .agree-text a {
      color: var(--color-accent);
      text-decoration: none;
      font-weight: 600;
    }
    .agree-text a:hover { text-decoration: underline; }

    /* ── Order Summary Sidebar ── */
    .checkout-summary {
      background: linear-gradient(180deg, var(--color-surface) 0%, #F0FDF4 100%);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-xl);
      padding: 2rem;
      position: sticky;
      top: 100px;
      height: fit-content;
      box-shadow: var(--shadow-md);
    }
    .checkout-summary-title {
      font-size: 1rem;
      font-weight: 700;
      color: var(--color-text);
      margin-bottom: 1.25rem;
      padding-bottom: 0.85rem;
      border-bottom: 1px solid var(--color-border);
    }
    .checkout-items {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      max-height: 320px;
      overflow-y: auto;
    }
    .checkout-item {
      display: flex;
      gap: 0.75rem;
      align-items: center;
    }
    .checkout-item-img {
      width: 52px;
      height: 52px;
      object-fit: contain;
      border-radius: var(--radius-sm);
      border: 1px solid var(--color-border);
      background: var(--color-surface);
      flex-shrink: 0;
    }
    .checkout-item-info {
      flex: 1;
      min-width: 0;
    }
    .checkout-item-title {
      font-size: 0.78rem;
      font-weight: 600;
      color: var(--color-text);
      display: -webkit-box;
      -webkit-line-clamp: 1;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .checkout-item-meta {
      font-size: 0.72rem;
      color: var(--color-text-muted);
      margin-top: 0.1rem;
    }
    .checkout-item-price {
      font-family: var(--font-display);
      font-size: 0.82rem;
      font-weight: 600;
      color: var(--color-text);
      flex-shrink: 0;
    }
    .checkout-divider {
      border: none;
      border-top: 1px solid var(--color-border);
      margin: 0.85rem 0;
    }
    .checkout-summary-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.35rem 0;
      font-size: 0.85rem;
      color: var(--color-text-secondary);
    }
    .checkout-total-row {
      padding-top: 0.5rem;
    }
    .checkout-total-row span:first-child {
      font-size: 1rem;
      font-weight: 700;
      color: var(--color-text);
    }
    .checkout-total-row span:last-child {
      font-size: 1.15rem;
      font-weight: 700;
      color: var(--color-text);
    }
    .checkout-tax-note {
      font-size: 0.72rem;
      color: var(--color-text-muted);
      margin-top: 0.5rem;
    }
  </style>

  <script define:vars={{ contactEmail: siteData.contact_email, bankDetails: siteData.bank_details, bitcoinAddress: siteData.bitcoin_address, emailjsConfig: (siteData).emailjs || {} }}>
    function getCart() {
      try { return JSON.parse(localStorage.getItem('vapelink_cart') || '[]'); } catch { return []; }
    }

    function saveCart(cart) {
      localStorage.setItem('vapelink_cart', JSON.stringify(cart));
      window.dispatchEvent(new CustomEvent('cart-updated'));
    }

    const FREE_SHIPPING_THRESHOLD = 100;
    function getShippingPrice(method, subtotal) {
      if (method === 'standard' && subtotal >= FREE_SHIPPING_THRESHOLD) return 0;
      return method === 'express' ? 14.95 : 9.95;
    }
    let currentStep = 1;

    function initCheckout() {
      const cart = getCart();
      const emptyEl = document.getElementById('checkout-empty');
      const contentEl = document.getElementById('checkout-content');
      if (!emptyEl || !contentEl) return;

      if (cart.length === 0) {
        emptyEl.style.display = 'block';
        contentEl.style.display = 'none';
        return;
      }

      // Enforce $300 minimum order at checkout
      const subtotal = cart.reduce((sum, item) => sum + (parseFloat(item.price || '0') * (item.qty || 1)), 0);
      if (subtotal < 300) {
        window.location.href = '/cart';
        return;
      }

      emptyEl.style.display = 'none';
      contentEl.style.display = 'block';

      renderSummary();
    }

    function renderSummary() {
      const cart = getCart();
      const itemsEl = document.getElementById('checkout-items');
      const subtotalEl = document.getElementById('checkout-subtotal');
      const shippingEl = document.getElementById('checkout-shipping');
      const totalEl = document.getElementById('checkout-total');
      if (!itemsEl) return;

      let subtotal = 0;
      itemsEl.innerHTML = cart.map(item => {
        const lineTotal = parseFloat(item.price || '0') * (item.qty || 1);
        subtotal += lineTotal;
        return `
          <div class="checkout-item">
            ${item.image ? `<img src="${item.image}" alt="" class="checkout-item-img" onerror="this.style.display='none'" />` : ''}
            <div class="checkout-item-info">
              <div class="checkout-item-title">${item.title}</div>
              <div class="checkout-item-meta">Qty: ${item.qty || 1}</div>
            </div>
            <span class="checkout-item-price">$${lineTotal.toFixed(2)}</span>
          </div>
        `;
      }).join('');

      const selectedShipping = document.querySelector('input[name="shipping"]:checked');
      const shippingKey = selectedShipping ? selectedShipping.value : 'standard';
      const shippingCost = getShippingPrice(shippingKey, subtotal);

      // Update shipping option labels to show FREE when applicable
      const stdPriceEl = document.querySelector('input[value="standard"]')?.closest('.shipping-option')?.querySelector('.shipping-price');
      if (stdPriceEl) stdPriceEl.textContent = subtotal >= FREE_SHIPPING_THRESHOLD ? 'FREE' : '$9.95';

      if (subtotalEl) subtotalEl.textContent = `$${subtotal.toFixed(2)}`;
      if (shippingEl) shippingEl.textContent = shippingCost === 0 ? 'FREE' : `$${shippingCost.toFixed(2)}`;
      if (totalEl) totalEl.textContent = `$${(subtotal + shippingCost).toFixed(2)} AUD`;
    }

    function goToStep(step) {
      currentStep = step;
      for (let i = 1; i <= 3; i++) {
        const el = document.getElementById(`step-${i}`);
        if (el) el.style.display = i === step ? 'block' : 'none';
      }
      document.querySelectorAll('.checkout-step[data-step]').forEach(el => {
        const s = parseInt(el.getAttribute('data-step') || '0');
        el.classList.remove('active', 'completed');
        if (s === step) el.classList.add('active');
        else if (s < step) el.classList.add('completed');
      });
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function validateStep1() {
      const email = document.getElementById('checkout-email');
      const fname = document.getElementById('checkout-fname');
      const lname = document.getElementById('checkout-lname');
      const address = document.getElementById('checkout-address');
      const city = document.getElementById('checkout-city');
      const state = document.getElementById('checkout-state');
      const postcode = document.getElementById('checkout-postcode');

      const fields = [email, fname, lname, address, city, state, postcode];
      let valid = true;

      fields.forEach(f => {
        if (!f) return;
        f.style.borderColor = '';
        if (!f.value.trim()) {
          f.style.borderColor = 'var(--color-sale)';
          valid = false;
        }
      });

      if (email && !email.value.includes('@')) {
        email.style.borderColor = 'var(--color-sale)';
        valid = false;
      }

      if (!valid) {
        const first = fields.find(f => f && f.style.borderColor !== '');
        if (first) first.focus();
      }

      return valid;
    }

    // Init
    initCheckout();

    // Step navigation
    document.getElementById('to-step-2')?.addEventListener('click', () => {
      if (validateStep1()) {
        goToStep(2);
      }
    });

    document.getElementById('back-step-1')?.addEventListener('click', () => goToStep(1));

    document.getElementById('to-step-3')?.addEventListener('click', () => {
      renderSummary();
      goToStep(3);
    });

    document.getElementById('back-step-2')?.addEventListener('click', () => goToStep(2));

    // Shipping radio changes
    document.querySelectorAll('input[name="shipping"]').forEach(r => {
      r.addEventListener('change', renderSummary);
    });

    // Agreement checkbox enables place order
    const agreeBox = document.getElementById('checkout-agree');
    const placeBtn = document.getElementById('place-order');
    agreeBox?.addEventListener('change', () => {
      if (placeBtn) placeBtn.disabled = !agreeBox.checked;
    });

    // Place order
    placeBtn?.addEventListener('click', () => {
      if (!agreeBox?.checked) return;

      const cart = getCart();
      if (cart.length === 0) return;

      const paymentMethod = document.querySelector('input[name="payment"]:checked')?.value || 'bank';
      const shippingMethod = document.querySelector('input[name="shipping"]:checked')?.value || 'standard';
      const subtotal = cart.reduce((sum, item) => sum + (parseFloat(item.price || '0') * (item.qty || 1)), 0);
      const shipCost = getShippingPrice(shippingMethod, subtotal);

      // Gather order data
      const orderData = {
        email: document.getElementById('checkout-email')?.value || '',
        phone: document.getElementById('checkout-phone')?.value || '',
        firstName: document.getElementById('checkout-fname')?.value || '',
        lastName: document.getElementById('checkout-lname')?.value || '',
        address: document.getElementById('checkout-address')?.value || '',
        address2: document.getElementById('checkout-address2')?.value || '',
        city: document.getElementById('checkout-city')?.value || '',
        state: document.getElementById('checkout-state')?.value || '',
        postcode: document.getElementById('checkout-postcode')?.value || '',
        shipping: shippingMethod,
        payment: paymentMethod,
        notes: document.getElementById('checkout-notes')?.value || '',
        items: cart,
        orderNumber: 'VL-' + Date.now().toString(36).toUpperCase(),
        date: new Date().toISOString(),
        subtotal: subtotal,
        shippingCost: shipCost,
        total: subtotal + shipCost,
        status: paymentMethod === 'bitcoin' ? 'awaiting_payment' : 'pending',
        bankDetails: paymentMethod === 'bank' ? bankDetails : null,
        bitcoinAddress: paymentMethod === 'bitcoin' ? bitcoinAddress : null,
        contactEmail: contactEmail
      };

      // Save order for confirmation page
      localStorage.setItem('vapelink_last_order', JSON.stringify(orderData));

      // Save order history by email (works for guest checkout too)
      try {
        const emailForHistory = (orderData.email || '').trim().toLowerCase();
        if (emailForHistory) {
          const ordersKey = `vapelink_orders_${emailForHistory}`;
          const orders = JSON.parse(localStorage.getItem(ordersKey) || '[]');
          orders.unshift(orderData);
          localStorage.setItem(ordersKey, JSON.stringify(orders));
        }
      } catch {}

      // Send initial admin notification for Bitcoin orders
      if (paymentMethod === 'bitcoin' && emailjsConfig.public_key && emailjsConfig.service_id && emailjsConfig.admin_template_id) {
        try {
          // Load EmailJS dynamically and send admin notification
          const ejsScript = document.createElement('script');
          ejsScript.src = 'https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js';
          ejsScript.onload = function() {
            try {
              emailjs.init(emailjsConfig.public_key);
              const itemsList = cart.map(function(item) {
                return item.title + ' x' + (item.qty || 1) + ' — $' + (parseFloat(item.price || '0') * (item.qty || 1)).toFixed(2);
              }).join('\n');
              emailjs.send(emailjsConfig.service_id, emailjsConfig.admin_template_id, {
                to_email: emailjsConfig.admin_email || contactEmail,
                order_number: orderData.orderNumber,
                customer_name: orderData.firstName + ' ' + orderData.lastName,
                customer_email: orderData.email,
                customer_phone: orderData.phone || 'Not provided',
                items: itemsList,
                total_aud: '$' + orderData.total.toFixed(2) + ' AUD',
                total_btc: 'Pending BTC rate lookup',
                payment_method: 'Bitcoin (BTC) — Awaiting Payment',
                shipping_method: shippingMethod === 'express' ? 'Express Shipping' : 'Standard Shipping',
                shipping_address: [orderData.address, orderData.address2, orderData.city, orderData.state, orderData.postcode, 'Australia'].filter(Boolean).join(', '),
                order_date: new Date(orderData.date).toLocaleString('en-AU'),
                status: 'New Order — Awaiting Bitcoin Payment',
                notes: orderData.notes || 'None'
              });
            } catch(e) { console.error('Admin email error:', e); }
          };
          document.head.appendChild(ejsScript);
        } catch(e) { console.error('EmailJS load error:', e); }
      }

      // Clear cart
      saveCart([]);

      // Redirect to confirmation
      window.location.href = '/order-confirmation';
    });
  </script>

</Layout>
