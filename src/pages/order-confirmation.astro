---
import Layout from '../layouts/Layout.astro';
import siteData from '../data/site.json';
---

<Layout title="Order Confirmed – Vapelink Australia" description="Your order has been placed successfully. Thank you for shopping with Vapelink Australia." noindex={true}>

  <section class="container confirmation-page">
    <!-- No order data (direct visit) -->
    <div id="no-order" style="display:none;">
      <div class="confirmation-empty">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--color-text-dim)" stroke-width="1.2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
        <h2 class="font-display" style="font-size:1.2rem;font-weight:700;color:var(--color-text);margin-top:1rem;">No Order Found</h2>
        <p style="color:var(--color-text-secondary);font-size:0.88rem;margin-top:0.35rem;">It looks like you haven't placed an order yet.</p>
        <a href="/collections/shop" class="btn-primary" style="margin-top:1.25rem;padding:0.7rem 2rem;">Browse Products</a>
      </div>
    </div>

    <!-- Order Confirmation -->
    <div id="order-content" style="display:none;">
      <!-- Success Header -->
      <div class="confirmation-header">
        <div id="conf-header-icon" class="confirmation-check">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
        </div>
        <h1 id="conf-title" class="font-display confirmation-title">Order Confirmed!</h1>
        <p id="conf-subtitle" class="confirmation-subtitle">Thank you for your order. We've received your details and will process it shortly.</p>
        <div class="confirmation-order-num">
          <span>Order Number</span>
          <strong id="conf-order-num" class="font-display">—</strong>
        </div>
      </div>

      <!-- Payment-specific section (Bank Transfer / PayID) -->
      <div id="bank-payment-section" class="payment-instruction-section" style="display:none;">
        <div class="payment-instruction-card bank-card">
          <div class="payment-instruction-header">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--color-accent)" stroke-width="2"><path d="M3 21h18"/><path d="M3 10h18"/><path d="M5 6l7-3 7 3"/><path d="M4 10v11"/><path d="M20 10v11"/><path d="M8 14v4"/><path d="M12 14v4"/><path d="M16 14v4"/></svg>
            <h3 class="font-display">Bank Transfer / PayID</h3>
          </div>

          <div class="bank-pending-message">
            <div class="bank-pending-icon">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--color-accent)" stroke-width="1.5"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>
            </div>
            <h4 class="font-display" style="font-size:1.1rem;font-weight:700;color:var(--color-text);margin-top:1rem;">Payment Details Coming to Your Inbox</h4>
            <p style="color:var(--color-text-secondary);font-size:0.92rem;line-height:1.7;margin-top:0.65rem;max-width:480px;">
              Thank you for placing your order! Our team will review it and send the <strong style="color:var(--color-text);">bank transfer or PayID payment details</strong> to your email address shortly.
            </p>

            <div class="bank-pending-details">
              <div class="bank-pending-row">
                <span>Order Number</span>
                <strong id="bank-reference" class="font-display" style="color:var(--color-accent);">—</strong>
              </div>
              <div class="bank-pending-row">
                <span>Amount Due</span>
                <strong id="bank-amount" class="font-display" style="color:var(--color-accent);">—</strong>
              </div>
              <div class="bank-pending-row">
                <span>Email</span>
                <strong id="bank-pending-email" class="font-display" style="color:var(--color-text);">—</strong>
              </div>
            </div>

            <p style="color:var(--color-text-muted);font-size:0.82rem;margin-top:1.25rem;line-height:1.6;">
              Please check your inbox (and spam folder) within the next few minutes. Once you receive the payment details, complete the transfer and send a screenshot of the payment to confirm your order.
            </p>
          </div>
        </div>
      </div>

      <!-- Payment-specific section (Bitcoin) -->
      <div id="bitcoin-payment-section" class="payment-instruction-section" style="display:none;">
        <div class="payment-instruction-card bitcoin-card">
          <div class="payment-instruction-header">
            <svg width="24" height="24" viewBox="0 0 64 64" fill="none"><circle cx="32" cy="32" r="32" fill="#F7931A"/><path d="M46.1 27.4c.6-4.2-2.6-6.5-7-8l1.4-5.7-3.5-.9-1.4 5.5c-.9-.2-1.9-.4-2.8-.7l1.4-5.5-3.5-.9-1.4 5.7c-.8-.2-1.5-.3-2.2-.5l0 0-4.8-1.2-1 3.7s2.6.6 2.5.6c1.4.4 1.7 1.3 1.6 2l-1.6 6.5c.1 0 .2.1.3.1l-.3-.1-2.3 9.1c-.2.4-.6 1.1-1.6.8 0 0-2.5-.6-2.5-.6l-1.7 4 4.5 1.1c.8.2 1.7.4 2.5.6l-1.5 5.8 3.5.9 1.4-5.7c1 .3 1.9.5 2.8.7l-1.4 5.7 3.5.9 1.5-5.8c5.8 1.1 10.2.7 12-4.6 1.5-4.2-.1-6.7-3.2-8.3 2.2-.5 3.9-2 4.4-5.1zM39.5 38.2c-1.1 4.2-8.2 1.9-10.5 1.4l1.9-7.5c2.3.6 9.7 1.7 8.6 6.1zm1-10.9c-1 3.9-6.9 1.9-8.8 1.4l1.7-6.8c2 .5 8.2 1.4 7.1 5.4z" fill="white"/></svg>
            <h3 class="font-display">Bitcoin Payment</h3>
          </div>
          <p class="payment-instruction-desc">Scan the QR code below or copy the Bitcoin address to send your payment.</p>

          <!-- BTC Amount and Timer -->
          <div class="btc-payment-status">
            <div class="btc-amount-box">
              <span class="btc-amount-label">Amount (AUD)</span>
              <span id="btc-aud-amount" class="btc-amount-value font-display">$0.00</span>
            </div>
            <div class="btc-amount-box">
              <span class="btc-amount-label">Amount (BTC)</span>
              <span id="btc-btc-amount" class="btc-amount-value font-display" style="color:#f7931a;">Loading...</span>
            </div>
            <div class="btc-timer-box" id="btc-timer-box">
              <span class="btc-timer-label">Payment Window</span>
              <span id="btc-timer" class="btc-timer-value font-display">30:00</span>
            </div>
            <div class="btc-status-box">
              <span class="btc-status-label">Status</span>
              <span id="btc-status" class="btc-status-value">
                <span class="btc-status-dot waiting"></span>
                Waiting for payment...
              </span>
            </div>
          </div>

          <!-- QR Code -->
          <div class="btc-qr-container">
            <div id="btc-qr-code" class="btc-qr-code"></div>
            <p class="btc-qr-hint">Scan with your Bitcoin wallet app</p>
          </div>

          <!-- Bitcoin Address -->
          <div class="btc-address-box">
            <span class="btc-address-label">Bitcoin Address</span>
            <div class="btc-address-row">
              <code id="btc-address" class="btc-address-text">—</code>
              <button id="btc-copy-btn" class="btc-copy-btn" title="Copy to clipboard">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                <span id="btc-copy-text">Copy</span>
              </button>
            </div>
          </div>

          <!-- Payment Progress -->
          <div id="btc-progress-section" class="btc-progress-section">
            <div class="btc-progress-bar-wrap">
              <div id="btc-progress-bar" class="btc-progress-bar"></div>
            </div>
            <div class="btc-progress-steps">
              <div class="btc-progress-step active" id="btc-step-1">
                <span class="btc-step-dot"></span>
                <span class="btc-step-text">Waiting</span>
              </div>
              <div class="btc-progress-step" id="btc-step-2">
                <span class="btc-step-dot"></span>
                <span class="btc-step-text">Detected</span>
              </div>
              <div class="btc-progress-step" id="btc-step-3">
                <span class="btc-step-dot"></span>
                <span class="btc-step-text">2 Confirmations</span>
              </div>
            </div>
          </div>

          <!-- Confirmation counter -->
          <div id="btc-confirmations" class="btc-confirmations" style="display:none;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
            <span>Blockchain Confirmations: <strong id="btc-conf-count">0</strong> / 2</span>
          </div>

          <!-- Completed state (hidden initially) -->
          <div id="btc-completed" class="btc-completed" style="display:none;">
            <div class="btc-completed-icon">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
            </div>
            <h4 class="font-display" style="font-size:1.05rem;font-weight:700;color:var(--color-text);margin-top:0.75rem;">Payment Confirmed!</h4>
            <p style="font-size:0.85rem;color:var(--color-text-secondary);margin-top:0.25rem;">Your Bitcoin payment has been received and your order is now being processed.</p>
            <p style="font-size:0.82rem;color:var(--color-text-muted);margin-top:0.5rem;">Payment confirmed. Please keep your order number for reference.</p>
          </div>
        </div>
      </div>

      <div class="confirmation-grid">
        <!-- Order Details -->
        <div class="confirmation-details">
          <!-- Customer Info -->
          <div class="conf-section">
            <h3 class="font-display conf-section-title">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--color-accent)" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
              Customer Details
            </h3>
            <div class="conf-info-grid">
              <div>
                <span class="conf-label">Name</span>
                <span id="conf-name" class="conf-value">—</span>
              </div>
              <div>
                <span class="conf-label">Email</span>
                <span id="conf-email" class="conf-value">—</span>
              </div>
              <div>
                <span class="conf-label">Phone</span>
                <span id="conf-phone" class="conf-value">—</span>
              </div>
            </div>
          </div>

          <!-- Shipping -->
          <div class="conf-section">
            <h3 class="font-display conf-section-title">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--color-accent)" stroke-width="2"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
              Shipping Address
            </h3>
            <p id="conf-address" class="conf-value" style="line-height:1.6;">—</p>
          </div>

          <!-- Shipping Method -->
          <div class="conf-section">
            <h3 class="font-display conf-section-title">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--color-accent)" stroke-width="2"><rect x="1" y="3" width="15" height="13"/><path d="m16 8 4 2v6H16"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>
              Delivery Method
            </h3>
            <span id="conf-shipping" class="conf-value">—</span>
          </div>

          <!-- Payment -->
          <div class="conf-section">
            <h3 class="font-display conf-section-title">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--color-accent)" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><path d="M1 10h22"/></svg>
              Payment Method
            </h3>
            <span id="conf-payment" class="conf-value">—</span>
          </div>

          <!-- Notes -->
          <div id="conf-notes-section" class="conf-section" style="display:none;">
            <h3 class="font-display conf-section-title">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--color-accent)" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
              Order Notes
            </h3>
            <p id="conf-notes" class="conf-value" style="line-height:1.6;">—</p>
          </div>
        </div>

        <!-- Items Summary -->
        <div class="confirmation-items-card">
          <h3 class="font-display conf-section-title" style="margin-bottom:1rem;">Items Ordered</h3>
          <div id="conf-items" class="conf-items-list"></div>
          <hr class="conf-divider" />
          <div class="conf-total-row">
            <span>Subtotal</span>
            <span id="conf-subtotal" class="font-display" style="font-weight:600;">$0.00</span>
          </div>
          <div class="conf-total-row">
            <span>Shipping</span>
            <span id="conf-ship-cost" class="font-display" style="font-weight:600;">$0.00</span>
          </div>
          <hr class="conf-divider" />
          <div class="conf-total-row conf-grand-total">
            <span>Total</span>
            <span id="conf-total" class="font-display">$0.00 AUD</span>
          </div>
        </div>
      </div>

      <!-- Next Steps (dynamic based on payment) -->
      <div id="next-steps-bank" class="confirmation-next-steps" style="display:none;">
        <div class="next-step-card">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--color-accent)" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>
          <div>
            <h4 class="font-display" style="font-size:0.88rem;font-weight:700;color:var(--color-text);">Check Your Email</h4>
            <p style="font-size:0.78rem;color:var(--color-text-secondary);margin-top:0.15rem;">We'll send the bank transfer details to your email address shortly. Please check your inbox and spam folder.</p>
          </div>
        </div>
        <div class="next-step-card">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--color-accent)" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
          <div>
            <h4 class="font-display" style="font-size:0.88rem;font-weight:700;color:var(--color-text);">Make Payment & Send Receipt</h4>
            <p style="font-size:0.78rem;color:var(--color-text-secondary);margin-top:0.15rem;">Once you receive the bank details, transfer the amount and send a screenshot of the payment to confirm your order.</p>
          </div>
        </div>
        <div class="next-step-card">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--color-accent)" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
          <div>
            <h4 class="font-display" style="font-size:0.88rem;font-weight:700;color:var(--color-text);">Processing Time</h4>
            <p style="font-size:0.78rem;color:var(--color-text-secondary);margin-top:0.15rem;">Once we confirm your payment, we'll pack and ship within 1–2 business days. You'll get a tracking number by email.</p>
          </div>
        </div>
      </div>

      <div id="next-steps-bitcoin" class="confirmation-next-steps" style="display:none;">
        <div class="next-step-card">
          <svg width="20" height="20" viewBox="0 0 64 64" fill="none"><circle cx="32" cy="32" r="32" fill="#F7931A"/><path d="M46.1 27.4c.6-4.2-2.6-6.5-7-8l1.4-5.7-3.5-.9-1.4 5.5c-.9-.2-1.9-.4-2.8-.7l1.4-5.5-3.5-.9-1.4 5.7c-.8-.2-1.5-.3-2.2-.5l0 0-4.8-1.2-1 3.7s2.6.6 2.5.6c1.4.4 1.7 1.3 1.6 2l-1.6 6.5c.1 0 .2.1.3.1l-.3-.1-2.3 9.1c-.2.4-.6 1.1-1.6.8 0 0-2.5-.6-2.5-.6l-1.7 4 4.5 1.1c.8.2 1.7.4 2.5.6l-1.5 5.8 3.5.9 1.4-5.7c1 .3 1.9.5 2.8.7l-1.4 5.7 3.5.9 1.5-5.8c5.8 1.1 10.2.7 12-4.6 1.5-4.2-.1-6.7-3.2-8.3 2.2-.5 3.9-2 4.4-5.1zM39.5 38.2c-1.1 4.2-8.2 1.9-10.5 1.4l1.9-7.5c2.3.6 9.7 1.7 8.6 6.1zm1-10.9c-1 3.9-6.9 1.9-8.8 1.4l1.7-6.8c2 .5 8.2 1.4 7.1 5.4z" fill="white"/></svg>
          <div>
            <h4 class="font-display" style="font-size:0.88rem;font-weight:700;color:var(--color-text);">Send Bitcoin Payment</h4>
            <p style="font-size:0.78rem;color:var(--color-text-secondary);margin-top:0.15rem;">Scan the QR code or copy the Bitcoin address above and send the exact amount from your wallet.</p>
          </div>
        </div>
        <div class="next-step-card">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--color-accent)" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
          <div>
            <h4 class="font-display" style="font-size:0.88rem;font-weight:700;color:var(--color-text);">Automatic Detection</h4>
            <p style="font-size:0.78rem;color:var(--color-text-secondary);margin-top:0.15rem;">Our system will automatically detect your payment. Stay on this page to see real-time confirmation status.</p>
          </div>
        </div>
        <div class="next-step-card">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--color-accent)" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>
          <div>
            <h4 class="font-display" style="font-size:0.88rem;font-weight:700;color:var(--color-text);">Keep Your Order Number</h4>
            <p style="font-size:0.78rem;color:var(--color-text-secondary);margin-top:0.15rem;">Save this page and your order number so our team can quickly assist you if needed.</p>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="confirmation-actions">
        <a href="/collections/shop" class="btn-primary" style="padding:0.75rem 2rem;">
          Continue Shopping
        </a>
        <a href="/" class="btn-secondary" style="padding:0.75rem 2rem;text-decoration:none;">
          Back to Home
        </a>
      </div>
    </div>
  </section>

  <style is:global>
    .confirmation-page {
      padding-top: var(--space-xl);
      padding-bottom: var(--space-3xl);
      min-height: 60vh;
    }

    .confirmation-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      padding: 4rem 1rem;
    }

    /* ── Success Header ── */
    .confirmation-header {
      text-align: center;
      margin-bottom: 2.5rem;
      padding: 3rem 2rem;
      background: linear-gradient(145deg, #F0FDF4 0%, #DCFCE7 100%);
      border: 1px solid rgba(22,163,74,0.18);
      border-radius: var(--radius-xl);
      box-shadow: 0 8px 40px rgba(22,163,74,0.08);
    }
    .confirmation-check {
      width: 68px;
      height: 68px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--color-accent) 0%, #15803d 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1.25rem;
      box-shadow: 0 6px 24px rgba(22,163,74,0.35);
    }
    .confirmation-check.btc-waiting {
      background: linear-gradient(135deg, #f7931a 0%, #e67e00 100%);
      box-shadow: 0 6px 24px rgba(247, 147, 26, 0.35);
    }
    .confirmation-title {
      font-size: 1.85rem;
      font-weight: 800;
      color: var(--color-text);
      letter-spacing: -0.025em;
    }
    .confirmation-subtitle {
      color: var(--color-text-secondary);
      font-size: 0.95rem;
      margin-top: 0.5rem;
      max-width: 520px;
      margin-left: auto;
      margin-right: auto;
      line-height: 1.6;
    }
    .confirmation-order-num {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      gap: 0.25rem;
      margin-top: 1.5rem;
      padding: 1rem 2.25rem;
      background: var(--color-surface);
      border: 1.5px solid rgba(22,163,74,0.25);
      border-radius: var(--radius-lg);
      box-shadow: 0 4px 16px rgba(22,163,74,0.1);
    }
    .confirmation-order-num span {
      font-size: 0.7rem;
      font-weight: 700;
      color: var(--color-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    .confirmation-order-num strong {
      font-size: 1.25rem;
      color: var(--color-accent);
    }

    /* ── Payment Instruction Cards ── */
    .payment-instruction-section {
      margin-bottom: 2rem;
    }
    .payment-instruction-card {
      background: var(--color-surface);
      border: 1.5px solid var(--color-border);
      border-radius: var(--radius-lg);
      padding: 2rem;
    }
    .payment-instruction-card.bank-card {
      border-color: var(--color-accent);
    }
    .payment-instruction-card.bitcoin-card {
      border-color: #f7931a;
    }
    .payment-instruction-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }
    .payment-instruction-header h3 {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--color-text);
    }
    .payment-instruction-desc {
      font-size: 0.88rem;
      color: var(--color-text-secondary);
      margin-bottom: 1.5rem;
      line-height: 1.5;
    }

    /* Bank Pending Message */
    .bank-pending-message {
      text-align: center;
      padding: 2rem 1rem;
    }
    .bank-pending-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--color-accent-soft);
      margin: 0 auto;
    }
    .bank-pending-details {
      display: flex;
      flex-direction: column;
      gap: 0;
      margin: 1.5rem auto 0;
      max-width: 380px;
      background: var(--color-surface-alt);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      overflow: hidden;
    }
    .bank-pending-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.85rem 1.15rem;
      border-bottom: 1px solid var(--color-border);
      font-size: 0.88rem;
    }
    .bank-pending-row:last-child { border-bottom: none; }
    .bank-pending-row span {
      color: var(--color-text-secondary);
      font-weight: 500;
    }

    /* Important Note */
    .payment-important-note {
      display: flex;
      gap: 0.85rem;
      padding: 1.15rem 1.25rem;
      background: #fef3c7;
      border: 1.5px solid #f59e0b;
      border-radius: var(--radius-md);
      margin-bottom: 1.25rem;
      align-items: flex-start;
    }
    [data-theme="dark"] .payment-important-note {
      background: rgba(245, 158, 11, 0.1);
    }
    .payment-important-note svg {
      flex-shrink: 0;
      margin-top: 0.1rem;
    }
    .note-title {
      font-size: 0.88rem;
      font-weight: 700;
      color: #92400e;
      margin-bottom: 0.3rem;
    }
    [data-theme="dark"] .note-title {
      color: #fbbf24;
    }
    .note-text {
      font-size: 0.82rem;
      color: #78350f;
      line-height: 1.6;
    }
    [data-theme="dark"] .note-text {
      color: var(--color-text-secondary);
    }
    .payment-email-note {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.82rem;
      color: var(--color-accent);
      font-weight: 600;
      padding-top: 0.5rem;
    }

    /* ── Bitcoin Payment ── */
    .btc-payment-status {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }
    @media (max-width: 640px) {
      .btc-payment-status { grid-template-columns: 1fr; }
    }
    .btc-confirmations {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      justify-content: center;
      padding: 0.75rem 1rem;
      background: var(--color-surface-alt);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      margin-bottom: 1.5rem;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--color-text-secondary);
    }
    .btc-confirmations strong {
      color: #f7931a;
      font-size: 1rem;
    }
    .btc-confirmations.confirmed strong {
      color: var(--color-accent);
    }
    .btc-amount-box, .btc-timer-box, .btc-status-box {
      background: var(--color-surface-alt);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: 1rem;
      text-align: center;
    }
    .btc-amount-label, .btc-timer-label, .btc-status-label {
      display: block;
      font-size: 0.72rem;
      font-weight: 600;
      color: var(--color-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 0.35rem;
    }
    .btc-amount-value {
      font-size: 1.25rem;
      font-weight: 800;
      color: var(--color-text);
    }
    .btc-timer-value {
      font-size: 1.25rem;
      font-weight: 800;
      color: #f7931a;
    }
    .btc-timer-value.expired { color: var(--color-sale); }
    .btc-status-value {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--color-text);
    }
    .btc-status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
    }
    .btc-status-dot.waiting {
      background: #f7931a;
      animation: pulse-dot 1.5s ease-in-out infinite;
    }
    .btc-status-dot.detected {
      background: #22c55e;
      animation: pulse-dot 0.8s ease-in-out infinite;
    }
    .btc-status-dot.confirmed {
      background: var(--color-accent);
      animation: none;
    }
    @keyframes pulse-dot {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.3); }
    }

    /* QR Code */
    .btc-qr-container {
      text-align: center;
      margin-bottom: 1.5rem;
    }
    .btc-qr-code {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 200px;
      height: 200px;
      background: #fff;
      border: 2px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: 12px;
      margin: 0 auto;
    }
    .btc-qr-code img, .btc-qr-code canvas {
      max-width: 100%;
      max-height: 100%;
    }
    .btc-qr-hint {
      font-size: 0.75rem;
      color: var(--color-text-muted);
      margin-top: 0.5rem;
    }

    /* Bitcoin Address */
    .btc-address-box {
      margin-bottom: 1.5rem;
    }
    .btc-address-label {
      display: block;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--color-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-bottom: 0.4rem;
    }
    .btc-address-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: var(--color-surface-alt);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: 0.75rem 1rem;
    }
    .btc-address-text {
      flex: 1;
      font-size: 0.82rem;
      font-family: 'ui-monospace', 'SFMono-Regular', 'Monaco', 'Cascadia Code', monospace;
      color: var(--color-text);
      word-break: break-all;
      line-height: 1.4;
    }
    .btc-copy-btn {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.45rem 0.85rem;
      background: var(--color-accent);
      color: #fff;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 0.78rem;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      transition: background 0.15s;
    }
    .btc-copy-btn:hover {
      background: var(--color-accent-hover, #15803d);
    }

    /* BTC Progress */
    .btc-progress-section {
      margin-bottom: 1.5rem;
    }
    .btc-progress-bar-wrap {
      height: 4px;
      background: var(--color-border);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 0.75rem;
    }
    .btc-progress-bar {
      width: 10%;
      height: 100%;
      background: #f7931a;
      border-radius: 4px;
      transition: width 0.5s ease, background 0.3s;
    }
    .btc-progress-bar.confirmed {
      background: var(--color-accent);
    }
    .btc-progress-steps {
      display: flex;
      justify-content: space-between;
    }
    .btc-progress-step {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.75rem;
      color: var(--color-text-muted);
      font-weight: 600;
    }
    .btc-progress-step.active { color: #f7931a; }
    .btc-progress-step.completed { color: var(--color-accent); }
    .btc-step-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--color-border);
      transition: background 0.3s;
    }
    .btc-progress-step.active .btc-step-dot { background: #f7931a; }
    .btc-progress-step.completed .btc-step-dot { background: var(--color-accent); }

    .btc-completed {
      text-align: center;
      padding: 1.5rem;
    }
    .btc-completed-icon {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--color-accent);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 20px rgba(22, 163, 74, 0.3);
    }

    /* ── Grid ── */
    .confirmation-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 2rem;
      margin-bottom: 2.5rem;
    }
    @media (min-width: 1024px) {
      .confirmation-grid {
        grid-template-columns: 1fr 380px;
        gap: 2.5rem;
      }
    }

    /* ── Sections ── */
    .conf-section {
      padding: 1.25rem 0;
      border-bottom: 1px solid var(--color-border);
    }
    .conf-section:first-child { padding-top: 0; }
    .conf-section:last-child { border-bottom: none; }
    .conf-section-title {
      display: flex;
      align-items: center;
      gap: 0.55rem;
      font-size: 0.88rem;
      font-weight: 700;
      color: var(--color-text);
      margin-bottom: 0.65rem;
    }
    .conf-info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 0.75rem;
    }
    @media (max-width: 640px) {
      .conf-info-grid { grid-template-columns: 1fr; }
    }
    .conf-label {
      display: block;
      font-size: 0.72rem;
      font-weight: 600;
      color: var(--color-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-bottom: 0.2rem;
    }
    .conf-value {
      font-size: 0.88rem;
      color: var(--color-text);
    }

    /* ── Items Card ── */
    .confirmation-items-card {
      background: linear-gradient(180deg, var(--color-surface) 0%, #F0FDF4 100%);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-xl);
      padding: 2rem;
      height: fit-content;
      box-shadow: var(--shadow-md);
    }
    .conf-items-list {
      display: flex;
      flex-direction: column;
      gap: 0.65rem;
    }
    .conf-item {
      display: flex;
      align-items: center;
      gap: 0.65rem;
    }
    .conf-item-img {
      width: 44px;
      height: 44px;
      object-fit: contain;
      border-radius: var(--radius-sm);
      border: 1px solid var(--color-border);
      background: var(--color-surface);
      flex-shrink: 0;
    }
    .conf-item-info {
      flex: 1;
      min-width: 0;
    }
    .conf-item-title {
      font-size: 0.78rem;
      font-weight: 600;
      color: var(--color-text);
      display: -webkit-box;
      -webkit-line-clamp: 1;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .conf-item-qty {
      font-size: 0.72rem;
      color: var(--color-text-muted);
    }
    .conf-item-price {
      font-family: var(--font-display);
      font-size: 0.82rem;
      font-weight: 600;
      color: var(--color-text);
      flex-shrink: 0;
    }
    .conf-divider {
      border: none;
      border-top: 1px solid var(--color-border);
      margin: 0.75rem 0;
    }
    .conf-total-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.3rem 0;
      font-size: 0.85rem;
      color: var(--color-text-secondary);
    }
    .conf-grand-total span:first-child {
      font-size: 1rem;
      font-weight: 700;
      color: var(--color-text);
    }
    .conf-grand-total span:last-child {
      font-size: 1.15rem;
      font-weight: 700;
      color: var(--color-text);
    }

    /* ── Next Steps ── */
    .confirmation-next-steps {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.85rem;
      margin-bottom: 2rem;
    }
    @media (min-width: 768px) {
      .confirmation-next-steps { grid-template-columns: repeat(3, 1fr); }
    }
    .next-step-card {
      display: flex;
      gap: 0.85rem;
      align-items: flex-start;
      padding: 1.35rem;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
      transition: box-shadow 0.2s ease, transform 0.2s ease;
    }
    .next-step-card:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }
    .next-step-card svg {
      flex-shrink: 0;
      margin-top: 0.15rem;
    }

    /* ── Actions ── */
    .confirmation-actions {
      display: flex;
      justify-content: center;
      gap: 1rem;
      flex-wrap: wrap;
    }
  </style>

  <!-- EmailJS config passed from server -->
  <script define:vars={{ emailjsConfig: (siteData as any).emailjs || {}, siteContactEmail: siteData.contact_email }}>
    window.__VAPELINK_EMAIL_CONFIG = { emailjs: emailjsConfig, contactEmail: siteContactEmail };
  </script>

  <script>
    // ═══════════════════════════════════════════════════════════════
    // Vapelink Order Confirmation — Bitcoin Blockchain Monitor
    // Uses Mempool.space API for real blockchain monitoring
    // Uses EmailJS for email notifications
    // ═══════════════════════════════════════════════════════════════

    const shippingLabels: Record<string, string> = {
      standard: 'Standard Shipping (5–10 business days)',
      express: 'Express Shipping (2–4 business days)'
    };
    const shippingPrices: Record<string, number> = { standard: 9.95, express: 14.95 };
    const paymentLabels: Record<string, string> = {
      bank: 'Bank Transfer / PayID',
      bitcoin: 'Bitcoin (BTC)'
    };

    // ── Config from server ──
    const __emailConfig = (window as any).__VAPELINK_EMAIL_CONFIG || {};
    const emailjsConfig = __emailConfig.emailjs || {};
    const contactEmail = __emailConfig.contactEmail || '';

    // ── Constants ──
    const PAYMENT_WINDOW_SECS = 30 * 60; // 30 minute payment window
    const BLOCKCHAIN_POLL_INTERVAL = 15000; // Poll every 15 seconds
    const REQUIRED_CONFIRMATIONS = 2;
    const MEMPOOL_API = 'https://mempool.space/api';

    // ── State ──
    let btcTimerInterval: any = null;
    let btcPollInterval: any = null;
    let emailjsLoaded = false;
    let adminEmailSent = false;
    let userEmailSent = false;
    let btcAmountForOrder = '';
    let detectedTxId = '';

    // ═══════════════════════════════════════════
    // EmailJS Integration
    // ═══════════════════════════════════════════

    function loadEmailJS(): Promise<boolean> {
      return new Promise((resolve) => {
        if ((window as any).emailjs) {
          (window as any).emailjs.init(emailjsConfig.public_key);
          emailjsLoaded = true;
          resolve(true);
          return;
        }
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js';
        script.onload = () => {
          try {
            (window as any).emailjs.init(emailjsConfig.public_key);
            emailjsLoaded = true;
            resolve(true);
          } catch { resolve(false); }
        };
        script.onerror = () => resolve(false);
        document.head.appendChild(script);
      });
    }

    async function sendEmail(templateId: string, params: Record<string, string>): Promise<boolean> {
      if (!emailjsLoaded || !emailjsConfig.service_id || !emailjsConfig.public_key || !templateId) {
        console.warn('EmailJS not configured — skipping email send. Configure emailjs in site.json.');
        return false;
      }
      try {
        await (window as any).emailjs.send(emailjsConfig.service_id, templateId, params);
        console.log('Email sent successfully via template:', templateId);
        return true;
      } catch (e) {
        console.error('Email send error:', e);
        return false;
      }
    }

    function formatItemsList(items: any[]): string {
      return items.map((item: any) =>
        `${item.title} x${item.qty || 1} — $${(parseFloat(item.price || '0') * (item.qty || 1)).toFixed(2)}`
      ).join('\n');
    }

    async function sendAdminOrderEmail(order: any) {
      if (adminEmailSent) return;
      adminEmailSent = true;
      await sendEmail(emailjsConfig.admin_template_id, {
        to_email: emailjsConfig.admin_email || contactEmail,
        order_number: order.orderNumber,
        customer_name: `${order.firstName} ${order.lastName}`,
        customer_email: order.email,
        customer_phone: order.phone || 'Not provided',
        items: formatItemsList(order.items || []),
        total_aud: `$${order.total.toFixed(2)} AUD`,
        total_btc: btcAmountForOrder || 'N/A',
        payment_method: 'Bitcoin (BTC)',
        shipping_method: order.shipping === 'express' ? 'Express Shipping' : 'Standard Shipping',
        shipping_address: [order.address, order.address2, order.city, order.state, order.postcode, 'Australia'].filter(Boolean).join(', '),
        order_date: new Date(order.date).toLocaleString('en-AU'),
        status: 'Payment Confirmed (2+ blockchain confirmations)',
        tx_id: detectedTxId || 'N/A',
        notes: order.notes || 'None'
      });
    }

    async function sendUserConfirmationEmail(order: any) {
      if (userEmailSent) return;
      userEmailSent = true;
      await sendEmail(emailjsConfig.user_template_id, {
        to_email: order.email,
        customer_name: order.firstName,
        order_number: order.orderNumber,
        items: formatItemsList(order.items || []),
        total_aud: `$${order.total.toFixed(2)} AUD`,
        total_btc: btcAmountForOrder || 'N/A',
        payment_method: 'Bitcoin (BTC)',
        order_date: new Date(order.date).toLocaleString('en-AU'),
        shipping_method: order.shipping === 'express' ? 'Express Shipping (2–4 business days)' : 'Standard Shipping (5–10 business days)',
        tx_id: detectedTxId || 'N/A'
      });
    }

    // ═══════════════════════════════════════════
    // Bitcoin Price API
    // ═══════════════════════════════════════════

    async function fetchBtcAudRate(): Promise<number | null> {
      // Try CoinGecko first
      try {
        const res = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=aud');
        if (res.ok) {
          const data = await res.json();
          return data?.bitcoin?.aud || null;
        }
      } catch {}
      // Fallback: Blockchain.info ticker
      try {
        const res = await fetch('https://blockchain.info/ticker');
        if (res.ok) {
          const data = await res.json();
          return data?.AUD?.last || null;
        }
      } catch {}
      return null;
    }

    function audToBtc(audAmount: number, btcRate: number): string {
      return (audAmount / btcRate).toFixed(8);
    }

    function btcToSatoshis(btcString: string): number {
      return Math.round(parseFloat(btcString) * 100000000);
    }

    // ═══════════════════════════════════════════
    // Blockchain Monitoring (Mempool.space API)
    // ═══════════════════════════════════════════

    interface BlockchainResult {
      found: boolean;
      txid?: string;
      amountSats?: number;
      confirmations?: number;
      error?: boolean;
    }

    async function pollBlockchain(address: string, expectedSatoshis: number, orderTimeMs: number): Promise<BlockchainResult> {
      try {
        const [txsRes, heightRes] = await Promise.all([
          fetch(`${MEMPOOL_API}/address/${address}/txs`),
          fetch(`${MEMPOOL_API}/blocks/tip/height`)
        ]);

        if (!txsRes.ok || !heightRes.ok) {
          return { found: false, error: true };
        }

        const txs = await txsRes.json();
        const currentHeight = parseInt(await heightRes.text());

        if (!Array.isArray(txs)) return { found: false };

        for (const tx of txs) {
          // Look for an output sent to our address
          const output = tx.vout?.find((out: any) => out.scriptpubkey_address === address);
          if (!output) continue;

          const receivedSats = output.value;

          // Amount tolerance: accept within 2% to account for rounding and fee differences
          if (expectedSatoshis > 0) {
            const tolerance = expectedSatoshis * 0.02;
            if (Math.abs(receivedSats - expectedSatoshis) > tolerance) continue;
          }

          // Timing check: skip transactions confirmed well before the order was placed
          if (tx.status?.confirmed && tx.status?.block_time) {
            const txTimeMs = tx.status.block_time * 1000;
            // Allow 10 minutes grace before order time
            if (txTimeMs < orderTimeMs - 600000) continue;
          }

          // Calculate confirmations
          const confirmations = tx.status?.confirmed
            ? (currentHeight - tx.status.block_height + 1)
            : 0;

          return {
            found: true,
            txid: tx.txid,
            amountSats: receivedSats,
            confirmations: Math.max(0, confirmations)
          };
        }

        return { found: false };
      } catch (err) {
        console.error('Blockchain poll error:', err);
        return { found: false, error: true };
      }
    }

    // ═══════════════════════════════════════════
    // UI Rendering
    // ═══════════════════════════════════════════

    function renderConfirmation() {
      const orderStr = localStorage.getItem('vapelink_last_order');
      const noEl = document.getElementById('no-order');
      const contentEl = document.getElementById('order-content');
      if (!noEl || !contentEl) return;

      if (!orderStr) {
        noEl.style.display = 'block';
        contentEl.style.display = 'none';
        return;
      }

      let order;
      try {
        order = JSON.parse(orderStr);
      } catch {
        noEl.style.display = 'block';
        contentEl.style.display = 'none';
        return;
      }

      noEl.style.display = 'none';
      contentEl.style.display = 'block';

      // Order number
      const orderNumEl = document.getElementById('conf-order-num');
      if (orderNumEl) orderNumEl.textContent = order.orderNumber || '—';

      // Customer
      const nameEl = document.getElementById('conf-name');
      const emailEl = document.getElementById('conf-email');
      const phoneEl = document.getElementById('conf-phone');
      if (nameEl) nameEl.textContent = `${order.firstName} ${order.lastName}`;
      if (emailEl) emailEl.textContent = order.email || '—';
      if (phoneEl) phoneEl.textContent = order.phone || 'Not provided';

      // Address
      const addrEl = document.getElementById('conf-address');
      if (addrEl) {
        const parts = [order.address, order.address2, order.city, `${order.state} ${order.postcode}`, 'Australia'].filter(Boolean);
        addrEl.textContent = parts.join(', ');
      }

      // Shipping
      const shipEl = document.getElementById('conf-shipping');
      if (shipEl) {
        const label = shippingLabels[order.shipping] || order.shipping;
        const isFree = typeof order.shippingCost === 'number' && order.shippingCost === 0;
        shipEl.textContent = isFree ? `${label} — FREE` : label;
      }

      // Payment
      const payEl = document.getElementById('conf-payment');
      if (payEl) payEl.textContent = paymentLabels[order.payment] || order.payment;

      // Notes
      if (order.notes) {
        const notesSection = document.getElementById('conf-notes-section');
        const notesEl = document.getElementById('conf-notes');
        if (notesSection) notesSection.style.display = 'block';
        if (notesEl) notesEl.textContent = order.notes;
      }

      // Items
      const itemsEl = document.getElementById('conf-items');
      let subtotal = 0;
      if (itemsEl && order.items) {
        itemsEl.innerHTML = order.items.map((item: any) => {
          const lineTotal = parseFloat(item.price || '0') * (item.qty || 1);
          subtotal += lineTotal;
          return `
            <div class="conf-item">
              ${item.image ? `<img src="${item.image}" alt="" class="conf-item-img" onerror="this.style.display='none'" />` : ''}
              <div class="conf-item-info">
                <div class="conf-item-title">${item.title}</div>
                <div class="conf-item-qty">Qty: ${item.qty || 1} × $${parseFloat(item.price || '0').toFixed(2)}</div>
              </div>
              <span class="conf-item-price">$${lineTotal.toFixed(2)}</span>
            </div>
          `;
        }).join('');
      }

      // Use the shipping cost saved at checkout (respects free shipping logic)
      const shipCost = typeof order.shippingCost === 'number' ? order.shippingCost : (shippingPrices[order.shipping] || 0);
      const subtotalEl = document.getElementById('conf-subtotal');
      const shipCostEl = document.getElementById('conf-ship-cost');
      const totalEl = document.getElementById('conf-total');
      if (subtotalEl) subtotalEl.textContent = `$${subtotal.toFixed(2)}`;
      if (shipCostEl) shipCostEl.textContent = shipCost === 0 ? 'FREE' : `$${shipCost.toFixed(2)}`;
      const grandTotal = subtotal + shipCost;
      if (totalEl) totalEl.textContent = `$${grandTotal.toFixed(2)} AUD`;

      // ═══ Payment-specific rendering ═══
      if (order.payment === 'bank' || order.payment === 'payid') {
        renderBankPayment(order, grandTotal);
      } else if (order.payment === 'bitcoin') {
        renderBitcoinPayment(order, grandTotal);
      }
    }

    function renderBankPayment(order: any, total: number) {
      const titleEl = document.getElementById('conf-title');
      const subtitleEl = document.getElementById('conf-subtitle');
      if (titleEl) titleEl.textContent = 'Order Placed Successfully!';
      if (subtitleEl) subtitleEl.textContent = 'Your order has been received. We will send you the bank transfer details to your email shortly so you can complete the payment.';

      const bankSection = document.getElementById('bank-payment-section');
      if (bankSection) bankSection.style.display = 'block';

      const amountEl = document.getElementById('bank-amount');
      const refEl = document.getElementById('bank-reference');
      const pendingEmailEl = document.getElementById('bank-pending-email');
      if (amountEl) amountEl.textContent = `$${total.toFixed(2)} AUD`;
      if (refEl) refEl.textContent = order.orderNumber || '—';
      if (pendingEmailEl) pendingEmailEl.textContent = order.email || '—';

      const bankSteps = document.getElementById('next-steps-bank');
      if (bankSteps) bankSteps.style.display = 'grid';
    }

    // ═══════════════════════════════════════════
    // Bitcoin Payment Flow
    // ═══════════════════════════════════════════

    async function renderBitcoinPayment(order: any, total: number) {
      // If already confirmed (e.g. page refresh), show confirmed state immediately
      if (order.status === 'confirmed') {
        showConfirmedState(order);
        return;
      }

      // Update header
      const headerIcon = document.getElementById('conf-header-icon');
      const titleEl = document.getElementById('conf-title');
      const subtitleEl = document.getElementById('conf-subtitle');
      if (headerIcon) headerIcon.classList.add('btc-waiting');
      if (titleEl) titleEl.textContent = 'Awaiting Bitcoin Payment';
      if (subtitleEl) subtitleEl.textContent = 'Please send the exact BTC amount to the address below. Your payment is monitored on the blockchain in real time.';

      // Show bitcoin section
      const btcSection = document.getElementById('bitcoin-payment-section');
      if (btcSection) btcSection.style.display = 'block';

      // AUD amount
      const audEl = document.getElementById('btc-aud-amount');
      if (audEl) audEl.textContent = `$${total.toFixed(2)}`;

      // Fetch real BTC/AUD rate and calculate BTC amount
      const btcBtcEl = document.getElementById('btc-btc-amount');
      let expectedSatoshis = 0;

      const btcRate = await fetchBtcAudRate();
      if (btcRate) {
        const btcAmount = audToBtc(total, btcRate);
        btcAmountForOrder = `${btcAmount} BTC`;
        expectedSatoshis = btcToSatoshis(btcAmount);
        if (btcBtcEl) btcBtcEl.textContent = `₿ ${btcAmount}`;

        // Save BTC amount to order for reference
        try {
          const o = JSON.parse(localStorage.getItem('vapelink_last_order') || '{}');
          o.btcAmount = btcAmount;
          o.btcRate = btcRate;
          localStorage.setItem('vapelink_last_order', JSON.stringify(o));
        } catch {}
      } else {
        if (btcBtcEl) btcBtcEl.textContent = 'Rate unavailable';
      }

      // Bitcoin address
      const btcAddr = order.bitcoinAddress || '';
      const addrEl = document.getElementById('btc-address');
      if (addrEl) addrEl.textContent = btcAddr;

      // Generate QR code with bitcoin: URI including amount
      const qrEl = document.getElementById('btc-qr-code');
      if (qrEl && btcAddr) {
        const btcUri = btcRate
          ? `bitcoin:${btcAddr}?amount=${audToBtc(total, btcRate)}`
          : `bitcoin:${btcAddr}`;
        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(btcUri)}&format=svg&margin=8`;
        qrEl.innerHTML = `<img src="${qrUrl}" alt="Bitcoin Payment QR Code" width="176" height="176" style="border-radius:4px;" />`;
      }

      // Copy button
      const copyBtn = document.getElementById('btc-copy-btn');
      const copyText = document.getElementById('btc-copy-text');
      copyBtn?.addEventListener('click', () => {
        navigator.clipboard.writeText(btcAddr).then(() => {
          if (copyText) copyText.textContent = 'Copied!';
          setTimeout(() => { if (copyText) copyText.textContent = 'Copy'; }, 2000);
        }).catch(() => {
          const ta = document.createElement('textarea');
          ta.value = btcAddr;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          document.body.removeChild(ta);
          if (copyText) copyText.textContent = 'Copied!';
          setTimeout(() => { if (copyText) copyText.textContent = 'Copy'; }, 2000);
        });
      });

      // Load EmailJS in the background
      loadEmailJS();

      // Start countdown timer + blockchain monitoring
      startPaymentMonitor(order, btcAddr, expectedSatoshis);

      // Show bitcoin next steps
      const btcSteps = document.getElementById('next-steps-bitcoin');
      if (btcSteps) btcSteps.style.display = 'grid';
    }

    // ── Combined Timer + Blockchain Polling ──

    function startPaymentMonitor(order: any, address: string, expectedSatoshis: number) {
      const orderTimeMs = new Date(order.date).getTime();
      const timerEl = document.getElementById('btc-timer');
      const statusEl = document.getElementById('btc-status');

      let paymentDetected = false;
      let paymentConfirmed = false;

      // ── Countdown Timer (every 1 second) ──
      btcTimerInterval = setInterval(() => {
        if (paymentConfirmed) {
          clearInterval(btcTimerInterval);
          return;
        }

        const elapsed = Math.floor((Date.now() - orderTimeMs) / 1000);
        const remaining = Math.max(0, PAYMENT_WINDOW_SECS - elapsed);
        const mins = Math.floor(remaining / 60);
        const secs = remaining % 60;

        if (timerEl) {
          timerEl.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
          if (remaining <= 300 && remaining > 0) timerEl.classList.add('expired');
        }

        // Timer expired and no payment detected
        if (remaining <= 0 && !paymentDetected) {
          clearInterval(btcTimerInterval);
          if (btcPollInterval) clearInterval(btcPollInterval);
          if (timerEl) timerEl.textContent = 'EXPIRED';
          if (statusEl) {
            statusEl.innerHTML = '<span class="btc-status-dot" style="background:var(--color-sale);animation:none;"></span> Payment window expired';
          }
          // Update order status
          updateOrderStatus('expired');
        }
      }, 1000);

      // ── Blockchain Polling (every 15 seconds) ──
      async function doBlockchainPoll() {
        if (paymentConfirmed) return;

        const result = await pollBlockchain(address, expectedSatoshis, orderTimeMs);

        if (result.found && result.txid) {
          detectedTxId = result.txid;
          const confirmations = result.confirmations || 0;

          if (!paymentDetected) {
            // First time detecting the transaction
            paymentDetected = true;
            onPaymentDetected(order, result.txid, confirmations);
          }

          // Update confirmation count display
          updateConfirmationCount(confirmations);

          if (confirmations >= REQUIRED_CONFIRMATIONS && !paymentConfirmed) {
            // Payment fully confirmed!
            paymentConfirmed = true;
            if (btcPollInterval) clearInterval(btcPollInterval);
            if (btcTimerInterval) clearInterval(btcTimerInterval);
            onPaymentConfirmed(order, result.txid, confirmations);
          }
        }
      }

      // Initial poll immediately, then every BLOCKCHAIN_POLL_INTERVAL
      doBlockchainPoll();
      btcPollInterval = setInterval(doBlockchainPoll, BLOCKCHAIN_POLL_INTERVAL);
    }

    // ── Payment Detected (0 confirmations — tx in mempool) ──

    function onPaymentDetected(order: any, txid: string, confirmations: number) {
      const statusEl = document.getElementById('btc-status');
      if (statusEl) {
        statusEl.innerHTML = `<span class="btc-status-dot detected"></span> Payment detected — awaiting ${REQUIRED_CONFIRMATIONS} confirmations...`;
      }

      // Show confirmations counter
      const confSection = document.getElementById('btc-confirmations');
      if (confSection) confSection.style.display = 'flex';
      updateConfirmationCount(confirmations);

      // Update progress bar
      const progressBar = document.getElementById('btc-progress-bar');
      if (progressBar) progressBar.style.width = '50%';

      const step1 = document.getElementById('btc-step-1');
      const step2 = document.getElementById('btc-step-2');
      if (step1) { step1.classList.remove('active'); step1.classList.add('completed'); }
      if (step2) step2.classList.add('active');

      // Update header
      const titleEl = document.getElementById('conf-title');
      if (titleEl) titleEl.textContent = 'Payment Detected!';

      // Update order status in localStorage
      updateOrderStatus('awaiting_confirmation');
    }

    // ── Update confirmation count display ──

    function updateConfirmationCount(confirmations: number) {
      const countEl = document.getElementById('btc-conf-count');
      if (countEl) countEl.textContent = String(confirmations);

      const confSection = document.getElementById('btc-confirmations');
      if (confSection && confirmations >= REQUIRED_CONFIRMATIONS) {
        confSection.classList.add('confirmed');
      }

      // Update progress bar proportionally
      const progressBar = document.getElementById('btc-progress-bar');
      if (progressBar && confirmations > 0 && confirmations < REQUIRED_CONFIRMATIONS) {
        const pct = 50 + (confirmations / REQUIRED_CONFIRMATIONS) * 50;
        progressBar.style.width = `${Math.min(pct, 95)}%`;
      }

      // Update status text
      const statusEl = document.getElementById('btc-status');
      if (statusEl && confirmations > 0 && confirmations < REQUIRED_CONFIRMATIONS) {
        statusEl.innerHTML = `<span class="btc-status-dot detected"></span> ${confirmations} / ${REQUIRED_CONFIRMATIONS} confirmations...`;
      }
    }

    // ── Payment Confirmed (2+ confirmations) ──

    async function onPaymentConfirmed(order: any, txid: string, confirmations: number) {
      // Update status
      const statusEl = document.getElementById('btc-status');
      if (statusEl) statusEl.innerHTML = '<span class="btc-status-dot confirmed"></span> Payment confirmed!';

      // Update confirmations display
      updateConfirmationCount(confirmations);

      // Update progress bar
      const progressBar = document.getElementById('btc-progress-bar');
      if (progressBar) {
        progressBar.style.width = '100%';
        progressBar.classList.add('confirmed');
      }

      // Update progress steps
      const step1 = document.getElementById('btc-step-1');
      const step2 = document.getElementById('btc-step-2');
      const step3 = document.getElementById('btc-step-3');
      if (step1) { step1.classList.remove('active'); step1.classList.add('completed'); }
      if (step2) { step2.classList.remove('active'); step2.classList.add('completed'); }
      if (step3) step3.classList.add('completed');

      // Update header
      const headerIcon = document.getElementById('conf-header-icon');
      const titleEl = document.getElementById('conf-title');
      const subtitleEl = document.getElementById('conf-subtitle');
      if (headerIcon) headerIcon.classList.remove('btc-waiting');
      if (titleEl) titleEl.textContent = 'Payment Confirmed!';
      if (subtitleEl) subtitleEl.textContent = 'Your Bitcoin payment has been verified on the blockchain. Your order is now being processed and will ship soon.';

      // Show completed state, hide timer
      const timerBox = document.getElementById('btc-timer-box');
      if (timerBox) timerBox.style.display = 'none';
      const completedEl = document.getElementById('btc-completed');
      if (completedEl) completedEl.style.display = 'block';
      const timerEl = document.getElementById('btc-timer');
      if (timerEl) timerEl.textContent = '✓';

      // Update order status in localStorage
      updateOrderStatus('confirmed');

      // ═══ Send Email Notifications ═══
      // Admin: New confirmed Bitcoin order
      await sendAdminOrderEmail(order);
      // User: Order confirmation
      await sendUserConfirmationEmail(order);
    }

    // ── Show already-confirmed state (for page refreshes) ──

    function showConfirmedState(order: any) {
      const btcSection = document.getElementById('bitcoin-payment-section');
      if (btcSection) btcSection.style.display = 'block';

      // Header
      const headerIcon = document.getElementById('conf-header-icon');
      const titleEl = document.getElementById('conf-title');
      const subtitleEl = document.getElementById('conf-subtitle');
      if (headerIcon) headerIcon.classList.remove('btc-waiting');
      if (titleEl) titleEl.textContent = 'Payment Confirmed!';
      if (subtitleEl) subtitleEl.textContent = 'Your Bitcoin payment has been verified on the blockchain. Your order is now being processed and will ship soon.';

      // AUD amount
      const audEl = document.getElementById('btc-aud-amount');
      if (audEl) audEl.textContent = `$${order.total.toFixed(2)}`;

      // BTC amount (from saved order)
      const btcBtcEl = document.getElementById('btc-btc-amount');
      if (btcBtcEl && order.btcAmount) btcBtcEl.textContent = `₿ ${order.btcAmount}`;

      // Timer
      const timerBox = document.getElementById('btc-timer-box');
      if (timerBox) timerBox.style.display = 'none';

      // Status
      const statusEl = document.getElementById('btc-status');
      if (statusEl) statusEl.innerHTML = '<span class="btc-status-dot confirmed"></span> Payment confirmed!';

      // Address
      const addrEl = document.getElementById('btc-address');
      if (addrEl) addrEl.textContent = order.bitcoinAddress || '';

      // QR
      const qrEl = document.getElementById('btc-qr-code');
      if (qrEl) qrEl.innerHTML = '';

      // Progress bar
      const progressBar = document.getElementById('btc-progress-bar');
      if (progressBar) { progressBar.style.width = '100%'; progressBar.classList.add('confirmed'); }
      const step1 = document.getElementById('btc-step-1');
      const step2 = document.getElementById('btc-step-2');
      const step3 = document.getElementById('btc-step-3');
      if (step1) { step1.classList.remove('active'); step1.classList.add('completed'); }
      if (step2) step2.classList.add('completed');
      if (step3) step3.classList.add('completed');

      // Completed block
      const completedEl = document.getElementById('btc-completed');
      if (completedEl) completedEl.style.display = 'block';

      // Copy button
      const copyBtn = document.getElementById('btc-copy-btn');
      const copyText = document.getElementById('btc-copy-text');
      const btcAddr = order.bitcoinAddress || '';
      copyBtn?.addEventListener('click', () => {
        navigator.clipboard.writeText(btcAddr).then(() => {
          if (copyText) copyText.textContent = 'Copied!';
          setTimeout(() => { if (copyText) copyText.textContent = 'Copy'; }, 2000);
        }).catch(() => {});
      });

      // Show bitcoin next steps
      const btcSteps = document.getElementById('next-steps-bitcoin');
      if (btcSteps) btcSteps.style.display = 'grid';
    }

    // ── Update order status in localStorage ──

    function updateOrderStatus(status: string) {
      try {
        const orderStr = localStorage.getItem('vapelink_last_order');
        if (!orderStr) return;
        const updatedOrder = JSON.parse(orderStr);
        updatedOrder.status = status;
        if (detectedTxId) updatedOrder.btcTxId = detectedTxId;
        localStorage.setItem('vapelink_last_order', JSON.stringify(updatedOrder));

        // Also update in order history
        const emailForHistory = (updatedOrder.email || '').trim().toLowerCase();
        if (emailForHistory) {
          const ordersKey = `vapelink_orders_${emailForHistory}`;
          const orders = JSON.parse(localStorage.getItem(ordersKey) || '[]');
          const idx = orders.findIndex((o: any) => o.orderNumber === updatedOrder.orderNumber);
          if (idx !== -1) {
            orders[idx].status = status;
            if (detectedTxId) orders[idx].btcTxId = detectedTxId;
            localStorage.setItem(ordersKey, JSON.stringify(orders));
          }
        }
      } catch {}
    }

    // ═══ Initialize ═══
    renderConfirmation();
  </script>

</Layout>
