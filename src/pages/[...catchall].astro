---
export const prerender = false;

/**
 * Server-rendered catch-all route that handles old Shopify URL redirects.
 * Only reached when no static page matches the URL.
 */
const path = Astro.url.pathname;

// 1. Redirect Shopify nested: /collections/xxx/products/yyy → /products/yyy
const nestedMatch = path.match(/^\/collections\/[^/]+\/products\/([^/?]+)/);
if (nestedMatch) {
  return Astro.redirect(`/products/${nestedMatch[1]}`, 301);
}

// 2. Redirect /collections/vendors → /collections
if (path.startsWith('/collections/vendors')) {
  return Astro.redirect('/collections', 301);
}

// 3. Redirect /pages/contact-us → /contact
if (path === '/pages/contact-us') {
  return Astro.redirect('/contact', 301);
}

// 4. Redirect /pages/brands → /collections
if (path === '/pages/brands') {
  return Astro.redirect('/collections', 301);
}

// 5. Strip Shopify query params and redirect
const shopifyParams = ['variant', '_pos', '_sid', '_ss'];
const hasShopifyParams = shopifyParams.some(p => Astro.url.searchParams.has(p));
if (hasShopifyParams) {
  const cleanUrl = new URL(Astro.url);
  shopifyParams.forEach(p => cleanUrl.searchParams.delete(p));
  const target = cleanUrl.pathname + (cleanUrl.searchParams.toString() ? '?' + cleanUrl.searchParams.toString() : '');
  return Astro.redirect(target, 301);
}

// 6. Redirect unknown /collections/xxx paths → /collections
if (path.match(/^\/collections\/[^/]+/)) {
  return Astro.redirect('/collections', 301);
}

// 7. Redirect unknown /products/xxx paths → /collections/shop
if (path.match(/^\/products\/[^/]+/)) {
  return Astro.redirect('/collections/shop', 301);
}

// 8. Redirect unknown /pages/xxx paths → /
if (path.match(/^\/pages\/[^/]+/)) {
  return Astro.redirect('/', 301);
}

// Default: Return 404 response
return new Response(null, { status: 404 });
---
